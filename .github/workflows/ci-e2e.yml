# ===========================================================================
# GitHub Actions CI/CD â€” Dynamic Matrix with WIF & SARIF
# ===========================================================================
# Repo: gcp-infra-archtf
# License: Apache License 2.0
# ===========================================================================

name: "CI â€” Terraform E2E"

on:
  push:
    branches: [main]
    paths:
      - "modules/**"
      - "tools/**"
      - "Taskfile.yml"
      - ".github/workflows/ci-e2e.yml"
  pull_request:
    branches: [main]
    paths:
      - "modules/**"
      - "tools/**"
      - "Taskfile.yml"
      - ".github/workflows/ci-e2e.yml"

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  TF_IN_AUTOMATION: true
  TERRAFORM_VERSION: "1.10.2"

# â”€â”€ Job 1: Discover modules and build dynamic matrix â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
jobs:
  discover:
    name: "ğŸ” Discover Modules"
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
      has_modules: ${{ steps.set-matrix.outputs.has_modules }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Build Module Matrix
        id: set-matrix
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            # On PR: only changed modules
            BASE_REF="origin/${{ github.base_ref }}"
            git fetch origin "${{ github.base_ref }}" --depth=1
            MODULES=$(git diff --name-only "$BASE_REF"...HEAD \
              | grep '^modules/' \
              | cut -d/ -f1-2 \
              | sort -u \
              | jq -R -s -c 'split("\n") | map(select(length > 0))')
          else
            # On push to main: all modules
            MODULES=$(find modules -mindepth 1 -maxdepth 1 -type d \
              | sort \
              | jq -R -s -c 'split("\n") | map(select(length > 0))')
          fi

          if [ "$MODULES" = "[]" ] || [ -z "$MODULES" ]; then
            echo "matrix={\"module\":[]}" >> $GITHUB_OUTPUT
            echo "has_modules=false" >> $GITHUB_OUTPUT
          else
            echo "matrix={\"module\":$MODULES}" >> $GITHUB_OUTPUT
            echo "has_modules=true" >> $GITHUB_OUTPUT
          fi

          echo "ğŸ“¦ Discovered modules: $MODULES"

  # â”€â”€ Job 2: Validate (parallel per module) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  validate:
    name: "âœ… Validate â€” ${{ matrix.module }}"
    needs: discover
    if: needs.discover.outputs.has_modules == 'true'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.discover.outputs.matrix) }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Terraform Init
        run: terraform -chdir="${{ matrix.module }}" init -backend=false -input=false

      - name: Terraform Validate
        run: terraform -chdir="${{ matrix.module }}" validate

      - name: Terraform Format Check
        run: terraform fmt -check -diff "${{ matrix.module }}"

      - name: Setup TFLint
        uses: terraform-linters/setup-tflint@v4
        with:
          tflint_version: latest

      - name: TFLint
        run: |
          cd "${{ matrix.module }}"
          if ls *.tf 1>/dev/null 2>&1; then
            tflint --init && tflint
          fi

  # â”€â”€ Job 3: Security Scan with SARIF Upload â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  security-scan:
    name: "ğŸ”’ Security â€” ${{ matrix.module }}"
    needs: discover
    if: needs.discover.outputs.has_modules == 'true'
    runs-on: ubuntu-latest
    permissions:
      security-events: write
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.discover.outputs.matrix) }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run tfsec (Manual)
        run: |
          # Use the binary directly for more predictable pathing
          curl -s https://raw.githubusercontent.com/aquasecurity/tfsec/master/scripts/install_linux.sh | bash
          tfsec "${{ matrix.module }}" --format sarif --soft-fail --config-file tfsec.yaml > results.sarif

      - name: Upload SARIF to GitHub Security
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: results.sarif
          category: tfsec-${{ matrix.module }}

  # â”€â”€ Job 4: E2E Tests with WIF Auth â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  e2e-test:
    name: "ğŸ§ª E2E â€” ${{ matrix.module }}"
    needs: [discover, validate]
    # Skip E2E for Dependabot as it lacks secret access for cloud tests
    if: |
      needs.discover.outputs.has_modules == 'true' &&
      github.actor != 'dependabot[bot]'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write    # Required for WIF
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.discover.outputs.matrix) }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4


      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      # â”€â”€ Workload Identity Federation (WIF) â”€â”€
      - name: Authenticate to GCP via WIF
        if: env.WIF_PROVIDER != ''
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ vars.WIF_PROVIDER }}
          service_account: ${{ vars.WIF_SERVICE_ACCOUNT }}
        env:
          WIF_PROVIDER: ${{ vars.WIF_PROVIDER }}

      - name: Terraform Init
        run: terraform -chdir="${{ matrix.module }}" init -backend=false -input=false

      - name: Terraform Test
        id: test
        run: |
          if [ -d "${{ matrix.module }}/tests" ]; then
            terraform -chdir="${{ matrix.module }}" test -no-color
          else
            echo "â­ï¸ No tests found for ${{ matrix.module }}"
          fi

      # â”€â”€ Auto-Cleanup (always runs, even on failure) â”€â”€
      - name: Cleanup â€” Terraform Destroy
        if: always()
        run: |
          echo "ğŸ§¹ Running cleanup for ${{ matrix.module }}..."
          # Only destroy if state exists (apply-based tests)
          if [ -f "${{ matrix.module }}/terraform.tfstate" ]; then
            terraform -chdir="${{ matrix.module }}" destroy -auto-approve -input=false || true
          else
            echo "â„¹ï¸ No state file â€” plan-only tests, no cleanup needed."
          fi

  # â”€â”€ Job 5: Summary Gate â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  ci-gate:
    name: "ğŸ CI Gate"
    needs: [validate, security-scan, e2e-test]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Check Results
        run: |
          if [ "${{ needs.validate.result }}" = "failure" ] || \
             [ "${{ needs.e2e-test.result }}" = "failure" ]; then
            echo "âŒ CI failed. Check individual job logs."
            exit 1
          fi
          echo "âœ… All CI checks passed."
